import TelegramBot from 'node-telegram-bot-api';
import { logger } from '../utils/logger';

export class TelegramService {
    private bot: TelegramBot;
    private chatId: string;
    private onRestartCallback?: () => Promise<void>;

    constructor(token: string, chatId: string) {
        this.chatId = chatId;
        this.bot = new TelegramBot(token, { polling: true });
        this.setupCommandHandlers();
    }

    private setupCommandHandlers(): void {
        // ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ /restart
        this.bot.onText(/\/restart/, async (msg) => {
            const chatId = msg.chat.id.toString();
            
            // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ ÐºÐ¾Ð¼Ð°Ð½Ð´Ð° Ð¿Ñ€Ð¸ÑˆÐ»Ð° Ð¸Ð· Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð¾Ð²Ð°Ð½Ð½Ð¾Ð³Ð¾ Ñ‡Ð°Ñ‚Ð°
            if (chatId !== this.chatId) {
                logger.warn(`âš ï¸ ÐŸÐ¾Ð¿Ñ‹Ñ‚ÐºÐ° Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ /restart Ð¸Ð· Ð½ÐµÐ°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð¾Ð²Ð°Ð½Ð½Ð¾Ð³Ð¾ Ñ‡Ð°Ñ‚Ð°: ${chatId}`);
                return;
            }

            logger.info(`ðŸ”„ ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð° ÐºÐ¾Ð¼Ð°Ð½Ð´Ð° /restart Ð¾Ñ‚ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ: ${msg.from?.first_name || 'Unknown'}`);
            
            try {
                await this.bot.sendMessage(chatId, 'ðŸ”„ ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº Ð±Ð¾Ñ‚Ð°...');
                
                if (this.onRestartCallback) {
                    await this.onRestartCallback();
                    await this.bot.sendMessage(chatId, 'âœ… Ð‘Ð¾Ñ‚ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑ‰ÐµÐ½!');
                } else {
                    await this.bot.sendMessage(chatId, 'âŒ ÐžÑˆÐ¸Ð±ÐºÐ°: callback Ð´Ð»Ñ Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐºÐ° Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½');
                }
            } catch (error) {
                logger.error('âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ð¸ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ /restart:', error);
                await this.bot.sendMessage(chatId, 'âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐºÐµ Ð±Ð¾Ñ‚Ð°');
            }
        });

        // ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ /status
        this.bot.onText(/\/status/, async (msg) => {
            const chatId = msg.chat.id.toString();
            
            if (chatId !== this.chatId) {
                return;
            }

            try {
                await this.bot.sendMessage(chatId, 'ðŸ¤– Ð‘Ð¾Ñ‚ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ Ð½Ð¾Ñ€Ð¼Ð°Ð»ÑŒÐ½Ð¾\n\nÐ”Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹:\n/restart - ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ Ð±Ð¾Ñ‚Ð°\n/status - ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ ÑÑ‚Ð°Ñ‚ÑƒÑ');
            } catch (error) {
                logger.error('âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ð¸ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ /status:', error);
            }
        });

        logger.info('ðŸ“± Telegram ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½Ñ‹: /restart, /status');
    }

    public setRestartCallback(callback: () => Promise<void>): void {
        this.onRestartCallback = callback;
    }

    public async sendMessage(message: string): Promise<void> {
        try {
            await this.bot.sendMessage(this.chatId, message, { parse_mode: 'HTML' });
            logger.info('Message sent to Telegram');
        } catch (error) {
            logger.error('Failed to send message to Telegram:', error);
        }
    }
} 